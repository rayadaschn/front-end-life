import{_ as n,X as s,Y as a,$ as p}from"./framework-5dd7fabc.js";const t={},e=p,o=s,l=a,c=e(`<p>本文记录一次 MCP（Model Context Protocol）在项目中的落地实践，不涉及具体业务细节，主要是对当时的设计思路与工程经验做一次复盘总结。</p><h2 id="一、明确目标-ai-在业务中的真实价值" tabindex="-1"><a class="header-anchor" href="#一、明确目标-ai-在业务中的真实价值" aria-hidden="true">#</a> 一、明确目标：AI 在业务中的真实价值</h2><p>虽然现在有大量 KOL 在宣传 AI Coding、AI Agent 的生产力提升，但在真实业务中，很多时候的感受是：</p><blockquote><p>工具很强，但不知道该用来干什么。</p></blockquote><p>根本原因其实不在于模型能力，而在于<strong>目标不清晰</strong>。</p><p>AI 在业务中的核心价值并不是“替代人类决策”，而是：</p><blockquote><p><strong>提炼重复性工作、结构化隐性知识、降低协作成本。</strong></p></blockquote><p>如果一个业务流程本身就不清楚、不稳定、不标准化，那么即使引入再强的模型，也只能得到一个“看起来很聪明，但并不可靠”的系统。</p><p>在我们项目中，AI 的目标非常明确：</p><ul><li>有大量重复但规则明确的操作</li><li>数据来源分散，需要统一调度</li><li>人工执行成本高，但逻辑可程序化</li></ul><p>这类场景，本质上非常适合 Agent + Tool 的模式。</p><h2 id="二、为什么选择-react-工作流" tabindex="-1"><a class="header-anchor" href="#二、为什么选择-react-工作流" aria-hidden="true">#</a> 二、为什么选择 ReAct 工作流</h2><p>在 Agent 设计上，最终选择了 ReAct（Reason + Act）模式，而不是一次性生成结果。</p><p>ReAct 的核心思想很简单：</p><blockquote><p>模型不是一步到位给答案，而是： 思考 → 调用工具 → 观察结果 → 再思考 → 再行动</p></blockquote><h2 id="三、mcp-在架构中的角色" tabindex="-1"><a class="header-anchor" href="#三、mcp-在架构中的角色" aria-hidden="true">#</a> 三、MCP 在架构中的角色</h2><p>如果说 ReAct 是“思维模式”，那 MCP 就是“工程协议”。</p><p>在我们的设计中：</p><ul><li>LLM 负责推理（Reason）</li><li>MCP Server 负责能力暴露</li><li>MCP Client 负责能力调用与调度</li></ul><p>也就是<strong>模型负责想，系统负责做。</strong></p><p>MCP 把这两件事通过一个标准协议解耦开来。</p><h3 id="mcp-的两个核心概念" tabindex="-1"><a class="header-anchor" href="#mcp-的两个核心概念" aria-hidden="true">#</a> MCP 的两个核心概念</h3><ul><li><p><strong>MCP Server</strong>：提供能力</p><ul><li>Tool（可执行函数）</li><li>Resource（结构化数据）</li><li>Prompt（模板上下文）</li></ul></li><li><p><strong>MCP Client</strong>：消费能力</p><ul><li>连接 Server</li><li>列出工具</li><li>调用工具</li><li>把结果喂回模型</li></ul></li></ul><p>这层抽象的价值在于： <strong>模型完全不需要知道真实系统的存在，只需要知道“我有哪些工具可以用”。</strong></p><h2 id="四、mcp-client-实际实现" tabindex="-1"><a class="header-anchor" href="#四、mcp-client-实际实现" aria-hidden="true">#</a> 四、MCP Client 实际实现</h2><p>首先初始化 MCP Client，并配置好模型连接。</p><p>我们这里使用 OpenAI SDK 来连接大语言模型，主要原因是：</p><ul><li>接口成熟</li><li>工具调用协议清晰</li><li>和 MCP 的 function schema 非常贴合</li></ul><blockquote><p>实际经验： 如果你本地部署的是 Qwen 这类模型，往往需要额外做一层 adapter，把它们的 function call 格式转成 OpenAI 风格。</p></blockquote><h3 id="基础连接示例" tabindex="-1"><a class="header-anchor" href="#基础连接示例" aria-hidden="true">#</a> 基础连接示例</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> OpenAI <span class="token keyword">from</span> <span class="token string">&#39;openai&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Client <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@modelcontextprotocol/sdk/client&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StdioClientTransport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@modelcontextprotocol/sdk/client/stdio&#39;</span>

<span class="token keyword">const</span> openai <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpenAI</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">apiKey</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">OPENAI_KEY</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 连接 MCP Server</span>
<span class="token keyword">const</span> transport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StdioClientTransport</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">command</span><span class="token operator">:</span> <span class="token string">&#39;node&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">args</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;./my-mcp-server.js&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> mcp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;my-client&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token string">&#39;1.0.0&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> mcp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>transport<span class="token punctuation">)</span>

<span class="token comment">// 获取工具</span>
<span class="token keyword">const</span> tools <span class="token operator">=</span> <span class="token keyword">await</span> mcp<span class="token punctuation">.</span><span class="token function">listTools</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 注入给模型</span>
<span class="token keyword">const</span> completion <span class="token operator">=</span> <span class="token keyword">await</span> openai<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token string">&#39;gpt-4.1&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">messages</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">role</span><span class="token operator">:</span> <span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">&#39;帮我查一下天气&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">tools</span><span class="token operator">:</span> tools<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> t<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      <span class="token literal-property property">description</span><span class="token operator">:</span> t<span class="token punctuation">.</span>description<span class="token punctuation">,</span>
      <span class="token literal-property property">parameters</span><span class="token operator">:</span> t<span class="token punctuation">.</span>inputSchema<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这一步本质上做了三件事：</p><ol><li>MCP Client 连接 MCP Server</li><li>拉取工具元信息</li><li>转成 LLM 可理解的 function schema</li></ol><p>从模型视角看，它根本不知道 MCP 的存在，只觉得自己“突然多了一些函数可以调用”。</p><h2 id="五、react-在真实工程中的执行循环" tabindex="-1"><a class="header-anchor" href="#五、react-在真实工程中的执行循环" aria-hidden="true">#</a> 五、ReAct 在真实工程中的执行循环</h2><p>理论上的 ReAct 流程是：</p><div class="language-markdown line-numbers-mode" data-ext="md"><pre class="language-markdown"><code>User
↓
LLM (Thought)
↓
选择 Tool
↓
执行 Tool
↓
Observation
↓
LLM (下一步 Thought)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>工程上，我们需要做的是：</p><ul><li>维护 message history</li><li>解析 tool_calls</li><li>执行 MCP tool</li><li>把结果继续塞回 messages</li></ul><h3 id="一个最小可运行版本" tabindex="-1"><a class="header-anchor" href="#一个最小可运行版本" aria-hidden="true">#</a> 一个最小可运行版本</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> systemPrompt <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">
You are a ReAct agent.

Use format:
Thought:
Action:
Action Input:
Observation:
Final:
</span><span class="token template-punctuation string">\`</span></span>

<span class="token keyword">let</span> messages <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">role</span><span class="token operator">:</span> <span class="token string">&#39;system&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> systemPrompt <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">role</span><span class="token operator">:</span> <span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">&#39;现在几点？&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">// ReAct Loop</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> openai<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token string">&#39;gpt-4.1&#39;</span><span class="token punctuation">,</span>
    messages<span class="token punctuation">,</span>
    tools<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> msg <span class="token operator">=</span> res<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message

  <span class="token comment">// 最终结果</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;Final:&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
    <span class="token keyword">break</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 调用工具</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>tool_calls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> call <span class="token operator">=</span> msg<span class="token punctuation">.</span>tool_calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>arguments<span class="token punctuation">)</span>

    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> mcp<span class="token punctuation">.</span><span class="token function">callTool</span><span class="token punctuation">(</span>call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>name<span class="token punctuation">,</span> args<span class="token punctuation">)</span>

    messages<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    messages<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">role</span><span class="token operator">:</span> <span class="token string">&#39;tool&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">tool_call_id</span><span class="token operator">:</span> call<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      <span class="token literal-property property">content</span><span class="token operator">:</span> result<span class="token punctuation">.</span>content<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这一段代码本质上就是一个最原始的 <strong>Agent Runtime</strong>。</p><p>类似的产品，底层做的事情也无非就是：</p><ul><li>更复杂的状态机</li><li>更精细的 memory 管理</li><li>更多类型的 tool / node</li></ul><h2 id="六、真实项目中的几个关键经验" tabindex="-1"><a class="header-anchor" href="#六、真实项目中的几个关键经验" aria-hidden="true">#</a> 六、真实项目中的几个关键经验</h2><p>真正把 MCP + Agent 跑进真实项目之后，会发现很多问题都不是“模型能力问题”，而是如何工程化落地，如何推广团队使用。</p><ol><li><p>开源 MCP Server 远远不够用，必须自定义工具。</p><p>目前社区里现成的 MCP Server 提供的工具并不完备，无法直接支撑真实业务。在实际项目中，几乎不可避免地需要自定义一些业务工具。这块比较考验统筹能力。</p></li><li><p>Agent 需要结构化的提示词</p><p>一开始是自己定结构化提示词的规范，后面发现这是其实 AI 自己做的更好。但是规范还是要有，就例如现在流行的 Skill。</p></li><li><p>不要一开始就追求完美 Agent，先跑起来再说</p><p>在工程化落地过程中，一个非常重要的心态转变是：<strong>先做出最小可用 Agent（MVP），而不是设计一个完美系统。</strong></p></li></ol>`,47),i=[c];function r(u,k){return o(),l("div",null,i)}const v=n(t,[["render",r],["__file","DesignPatterns04.html.vue"]]);export{v as default};
